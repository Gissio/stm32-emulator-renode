using sysbus

include @../src/STM32F1_ADC.cs
include @../src/STM32F1_FlashController.cs
include @../src/STM32F1_RCC.cs
include @../src/STM32F1_RTC.cs
include @../src/STM32F1_SPI.cs
include @../src/STM32F1_TIM.cs
include @../src/ST7789.cs

mach create
machine LoadPlatformDescription @emulation.repl

$bootloader_binary?=@firmware/fnirsi-gc03-bootloader.bin
sysbus LoadBinary $bootloader_binary 0x08000000

$firmware_binary?=@firmware/fnirsi-gc03-v1.0.4.bin
sysbus LoadBinary $firmware_binary 0x08006000

$settings_binary?=@firmware/settings.bin
sysbus LoadBinary $settings_binary 0x0803fc00

cpu VectorTableOffset 0x08000000

# Battery voltage
adc1 FeedSample 2482 10 1000000
# Electric field voltage
adc1 FeedSample 200 12 1000000
# Magnetic field voltage
adc1 FeedSample 200 13 1000000
# VREF
adc1 FeedSample 1489 17 1000000

showAnalyzer spi1.st7789

logLevel -1 sysbus.gpioPortA.powerEnable
logLevel -1 sysbus.gpioPortB.emfMeterEn
logLevel -1 sysbus.gpioPortB.pulseLED
logLevel -1 sysbus.gpioPortB.vibrator
logLevel -1 sysbus.gpioPortB.pb12

# sysbus LogPeripheralAccess flash_controller

start
